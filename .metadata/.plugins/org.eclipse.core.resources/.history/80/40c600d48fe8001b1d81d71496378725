package de.unistuttgart.ma.importer.slo;

import java.io.IOException;
import java.util.List;
import java.util.Set;

import de.unistuttgart.gropius.slo.SloRule;
import de.unistuttgart.ma.importer.architecture.DataMapper;
import de.unistuttgart.gropius.slo.SloFactory;

public class SolomonImporter implements SloImporter {
	
	private final DataMapper gropiusmapper;
	
	private final SolomonApiQuerier querier;
	
	// TODO : this is a DeploymentEnvironment (currently either 'aws' or 'kubernetes', vgl. solomon/**/slo-rule.model.ts)
	private final String queryPathparam; 

	public SolomonImporter(String uri, String queryPathparam) {
		this.querier = new SolomonApiQuerier(uri);
		this.queryPathparam = queryPathparam;
		this.gropiusmapper = DataMapper.getMapper();
	}
	
	@Override
	public Set<SloRule> parse() {
		try {
			Set<SloFlatRule> slorules = querier.query(queryPathparam); 
			return parse(slorules);
		} catch (IOException | InterruptedException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
			throw new RuntimeException(e);
		}
	}
	
	private Set<SloRule> parse(Set<SloFlatRule> flatRules) {
		for (SloFlatRule flatRule : flatRules) {
			
			SloRule rule = SloFactory.eINSTANCE.createSloRule(); 
			
			rule.setName(flatRule.getName());
			rule.setPeriod(0);		//TODO
			rule.setThreshold(0);	//TODO
			
			rule.setGropiusProject(gropiusmapper.getProjectByID(new ID(flatRule.getGropiusProjectId())));
			rule.setGropiusComponent(value);
			rule.setGropiusComponentInterface(value);
			
			
			switch (rule.getPresetOptions()) {
			case CUSTOM:
				slo = new Slo(things, rule.getName());
				break;
			case AVAILABILITY:
				slo = new AvailabilitySlo(things, rule.getName());
				break;
			case RESPONSE_TIME:
				slo = new ReponsetimeSlo(things, rule.getName());
				break;

			default:
				slo = new Slo(things, rule.getName());
				break;
			}
			
			
			things.addSlo(slo);
		}
	}
}
